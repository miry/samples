version: 2
jobs:
  golang:
    working_directory: /go/src/github.com/miry/samples/
    docker:
      - image: circleci/golang:1.11.0
    environment:
      TEST_RESULTS: /tmp/test-results
    steps:
      - checkout
      - run: mkdir -p $TEST_RESULTS/{benchmarks,btree,codinggame,gohttproxy,list,queue}
      - run: go get -u github.com/jstemmer/go-junit-report
      - run: go get -v -t -d ./...
      - run: go test ./algorithms/... -v |& go-junit-report > $TEST_RESULTS/algorithms/report.xml
      - run: go test ./codinggame/... -v |& go-junit-report > $TEST_RESULTS/codinggame/report.xml
      - run: go test ./gohttproxy/... -v |& go-junit-report > $TEST_RESULTS/gohttproxy/report.xml
      - run: go test ./justforfunc/... -v |& go-junit-report > $TEST_RESULTS/justforfunc/report.xml
      - store_test_results:
          path: /tmp/test-results
  distribusion:
    working_directory: ~/samples/distribusion
    docker:
      - image: circleci/ruby:2.6.0-preview2
        environment:
          RUBYOPT: "--enable-frozen-string-literal"
    steps:
      - checkout:
          path: ~/samples
      - restore_cache:
          key: dependency-cache-{{ checksum "Gemfile.lock" }}
      - run: bundle install --path vendor/bundle
      - save_cache:
          key: dependency-cache-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run: bundle exec rubocop -c .rubocop.yml
      - run: bundle exec rake test
      - run: bundle exec ruby --enable-frozen-string-literal ./bin/local -v -s all -p $DISTRIBUSION_PASSPHRASE | sed s/"${DISTRIBUSION_PASSPHRASE}"/xxx/g

      - store_artifacts:
          path: coverage

workflows:
  version: 2
  distribusion:
    jobs:
      - distribusion
  tests:
    jobs:
      - golang
